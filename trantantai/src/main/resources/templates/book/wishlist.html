<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Yêu Thích - BookHaven</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
</head>
<body class="d-flex flex-column min-vh-100">
<th:block th:replace="~{layout::header}"></th:block>

<main class="flex-grow-1">
    <div class="container animate-fade-in">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang Chủ</a></li>
                <li class="breadcrumb-item active">Danh Sách Yêu Thích</li>
            </ol>
        </nav>

        <!-- Page Title -->
        <div class="wishlist-header">
            <div class="wishlist-title-section">
                <h1 class="wishlist-page-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                    </svg>
                    Danh Sách Yêu Thích
                </h1>
                <span class="wishlist-count-badge" th:text="${wishlistCount} + ' sản phẩm'">0 sản phẩm</span>
            </div>
            <div class="wishlist-actions" th:if="${!wishlistBooks.isEmpty()}">
                <button class="btn-clear-wishlist" id="clearWishlistBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                    Xóa tất cả
                </button>
            </div>
        </div>

        <!-- Wishlist Grid -->
        <div class="wishlist-container" th:if="${!wishlistBooks.isEmpty()}">
            <div class="row g-4 stagger-animation">
                <div class="col-6 col-md-4 col-lg-3" th:each="book : ${wishlistBooks}">
                    <div class="wishlist-card" th:data-book-id="${book.id}">
                        <!-- Remove Button -->
                        <button class="wishlist-remove-btn" th:data-book-id="${book.id}" title="Xóa khỏi yêu thích">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                            </svg>
                        </button>

                        <!-- Book Card Link -->
                        <a th:href="@{/book/{id}(id=${book.id})}" class="book-card-link">
                            <div class="book-card">
                                <div class="book-card-cover">
                                    <div class="book-card-spine"></div>
                                    <div class="book-card-front">
                                        <span class="book-card-category" th:text="${book.category != null ? book.category.name : 'Sách'}">Category</span>
                                        <h4 class="book-card-title" th:text="${book.title}">Title</h4>
                                        <p class="book-card-author" th:text="${book.author}">Author</p>
                                    </div>
                                    <!-- Out of Stock Badge -->
                                    <div class="book-card-badge out-of-stock" th:if="${book.quantity == 0}">Hết hàng</div>
                                </div>
                                <div class="book-card-info">
                                    <h5 class="book-card-name" th:text="${book.title}">Book Title</h5>
                                    <p class="book-card-writer" th:text="${book.author}">Author</p>
                                    <div class="book-card-footer">
                                        <span class="book-card-price">
                                            <span th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')}">100,000</span>đ
                                        </span>
                                        <span class="book-card-stock" th:if="${book.quantity > 0}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                            </svg>
                                            Còn hàng
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- Add to Cart Button -->
                        <form th:action="@{/books/add-to-cart}" method="post" class="wishlist-add-cart-form"
                              th:if="${book.quantity > 0}">
                            <input type="hidden" name="id" th:value="${book.id}">
                            <input type="hidden" name="name" th:value="${book.title}">
                            <input type="hidden" name="price" th:value="${book.price}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="wishlist-add-cart-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9z"/>
                                    <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1zm3.915 10L3.102 4h10.796l-1.313 7zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0m7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                                </svg>
                                Thêm vào giỏ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty Wishlist State -->
        <div class="empty-wishlist" th:if="${wishlistBooks.isEmpty()}">
            <div class="empty-wishlist-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" viewBox="0 0 16 16">
                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                </svg>
            </div>
            <h3 class="empty-wishlist-title">Danh sách yêu thích trống</h3>
            <p class="empty-wishlist-text">Bạn chưa thêm sản phẩm nào vào danh sách yêu thích.</p>
            <a href="/books" class="btn btn-primary btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492z"/>
                </svg>
                Khám phá sách ngay
            </a>
        </div>
    </div>
</main>

<th:block th:replace="~{layout::footer}"></th:block>

<script th:inline="javascript">
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';

document.addEventListener('DOMContentLoaded', function() {
    // Remove from wishlist
    document.querySelectorAll('.wishlist-remove-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();

            const bookId = this.dataset.bookId;
            const card = this.closest('.wishlist-card');

            try {
                const response = await fetch(`/api/wishlist/${bookId}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    // Animate removal
                    card.classList.add('removing');
                    setTimeout(() => {
                        card.closest('.col-6').remove();

                        // Update badge
                        const badge = document.querySelector('.wishlist-count-badge');
                        const remaining = document.querySelectorAll('.wishlist-card').length;
                        if (badge) {
                            badge.textContent = remaining + ' sản phẩm';
                        }

                        // Update header badge
                        const headerBadge = document.getElementById('wishlistBadge');
                        if (headerBadge) {
                            headerBadge.textContent = remaining;
                        }

                        // Show empty state if no items left
                        if (remaining === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('Error removing from wishlist:', error);
            }
        });
    });

    // Clear all wishlist
    const clearBtn = document.getElementById('clearWishlistBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', async function() {
            if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi danh sách yêu thích?')) {
                return;
            }

            try {
                const response = await fetch('/api/wishlist', {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error clearing wishlist:', error);
            }
        });
    }

    // Add to cart from wishlist
    document.querySelectorAll('.wishlist-add-cart-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = this.querySelector('.wishlist-add-cart-btn');
            const originalHtml = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            const formData = new FormData(this);

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Update cart badge
                    const cartBadge = document.querySelector('.cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cartCount;
                    }

                    // Update cart total
                    const cartTotal = document.querySelector('.cart-total');
                    if (cartTotal) {
                        const formattedTotal = new Intl.NumberFormat('vi-VN').format(data.cartTotal) + 'đ';
                        cartTotal.textContent = formattedTotal;
                    }

                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg> Đã thêm!';
                    btn.classList.add('btn-success-state');

                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('btn-success-state');
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
    });
});
</script>
</body>
</html>
