<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Sách Mới - BookHaven Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css?v=5}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400;1,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
<div class="admin-wrapper">
    <th:block th:replace="~{admin/layout::sidebar}"></th:block>

    <div class="admin-main">
        <th:block th:replace="~{admin/layout::topbar}"></th:block>

        <main class="admin-content">
            <!-- Breadcrumb -->
            <nav class="admin-breadcrumb">
                <a href="/admin">Dashboard</a>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
                <a href="/admin/books">Quản lý sách</a>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
                <span>Thêm sách mới</span>
            </nav>

            <!-- Form Card -->
            <div class="admin-form-card">
                <div class="form-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                        </svg>
                        Thêm Sách Mới
                    </h2>
                </div>
                <div class="form-body">
                    <form th:action="@{/admin/books/add}" th:object="${book}" method="post" class="admin-form">
                        <div class="form-group">
                            <label for="title" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492z"/>
                                </svg>
                                Tên sách <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="title" th:field="*{title}"
                                   th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'"
                                   placeholder="Nhập tên sách" required maxlength="50" autofocus>
                            <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="error-text"></span>
                        </div>

                        <div class="form-group">
                            <label for="author" class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/>
                                </svg>
                                Tác giả <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="author" th:field="*{author}"
                                   th:classappend="${#fields.hasErrors('author')} ? 'is-invalid'"
                                   placeholder="Nhập tên tác giả" required maxlength="50">
                            <span th:if="${#fields.hasErrors('author')}" th:errors="*{author}" class="error-text"></span>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="price" class="form-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.315 0-1.667-1.104-2.512-3.074-3.003l-.604-.165v-3.34c1.143.146 1.904.857 1.996 1.83h1.724c-.09-1.776-1.458-2.998-3.72-3.137V3h-1.043v1.163C5.312 4.31 4.025 5.474 4.025 7.15c0 1.513.954 2.362 2.77 2.77l.557.152v3.55c-1.284-.14-2.069-.911-2.152-1.84z"/>
                                    </svg>
                                    Giá (VNĐ) <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="price" th:field="*{price}"
                                       th:classappend="${#fields.hasErrors('price')} ? 'is-invalid'"
                                       placeholder="Nhập giá sách" step="1000" min="0">
                                <span th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="error-text"></span>
                            </div>

                            <div class="form-group">
                                <label for="categoryId" class="form-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M3 2v4.586l7 7L14.586 9l-7-7zM2 2a1 1 0 0 1 1-1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 2 6.586z"/>
                                    </svg>
                                    Danh mục <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="categoryId" th:field="*{categoryId}"
                                        th:classappend="${#fields.hasErrors('categoryId')} ? 'is-invalid'">
                                    <option value="">-- Chọn danh mục --</option>
                                    <option th:each="category : ${categories}"
                                            th:value="${category.id}"
                                            th:text="${category.name}">
                                    </option>
                                </select>
                                <span th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="error-text"></span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="quantity" class="form-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 1 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1"/>
                                    </svg>
                                    Số lượng tồn kho <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="quantity" th:field="*{quantity}"
                                       th:classappend="${#fields.hasErrors('quantity')} ? 'is-invalid'"
                                       placeholder="Nhập số lượng tồn kho" step="1" min="0">
                                <span th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="error-text"></span>
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="form-group">
                            <label class="form-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
                                </svg>
                                Hình ảnh sách (tối đa 3 ảnh)
                            </label>
                            <div class="image-upload-zone" id="uploadZone">
                                <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif,image/webp" multiple hidden>
                                <div class="upload-content">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                    </svg>
                                    <p class="upload-text">Kéo thả ảnh vào đây hoặc <span>chọn từ máy tính</span></p>
                                    <p class="upload-hint">JPEG, PNG, GIF, WebP - Tối đa 5MB mỗi ảnh</p>
                                </div>
                                <div class="upload-loading" style="display: none;">
                                    <div class="spinner"></div>
                                    <span>Đang tải lên...</span>
                                </div>
                            </div>
                            <div class="image-preview-grid" id="imagePreviewGrid"></div>
                            <!-- Hidden inputs for form binding -->
                            <div id="hiddenImageInputs"></div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-admin btn-admin-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                </svg>
                                Thêm Sách
                            </button>
                            <a href="/admin/books" class="btn-admin btn-admin-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                </svg>
                                Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin.js}"></script>

<style>
/* Additional form styles */
.admin-breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
    font-size: 0.875rem;
}

.admin-breadcrumb a {
    color: var(--admin-text-tertiary);
    text-decoration: none;
    transition: var(--transition-fast);
}

.admin-breadcrumb a:hover {
    color: var(--admin-accent);
}

.admin-breadcrumb svg {
    color: var(--admin-text-muted);
}

.admin-breadcrumb span {
    color: var(--admin-text);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
}

.error-text {
    display: block;
    margin-top: var(--space-xs);
    font-size: 0.8rem;
    color: var(--admin-danger);
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--admin-danger);
}

.form-control.is-invalid:focus,
.form-select.is-invalid:focus {
    border-color: var(--admin-danger);
    box-shadow: 0 0 0 3px var(--admin-danger-bg);
}

@media (max-width: 576px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Image Upload Zone */
.image-upload-zone {
    border: 2px dashed var(--admin-border);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    text-align: center;
    cursor: pointer;
    transition: var(--transition-fast);
    background: var(--admin-surface-hover);
    position: relative;
}

.image-upload-zone:hover,
.image-upload-zone.dragover {
    border-color: var(--admin-accent);
    background: var(--admin-accent-muted);
}

.image-upload-zone.uploading {
    pointer-events: none;
    opacity: 0.7;
}

.upload-content svg {
    color: var(--admin-text-muted);
    margin-bottom: var(--space-md);
}

.upload-text {
    color: var(--admin-text-secondary);
    margin: 0 0 var(--space-xs);
    font-weight: 500;
}

.upload-text span {
    color: var(--admin-accent);
    font-weight: 600;
}

.upload-hint {
    color: var(--admin-text-muted);
    font-size: 0.8rem;
    margin: 0;
}

.upload-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.9);
    border-radius: var(--radius-md);
    gap: var(--space-sm);
}

.upload-loading .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--admin-border);
    border-top-color: var(--admin-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Image Preview Grid */
.image-preview-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    margin-top: var(--space-md);
}

.image-preview-item {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 2px solid var(--admin-border);
}

.image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-preview-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    background: var(--admin-danger);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: var(--transition-fast);
}

.image-preview-item:hover .image-preview-remove {
    opacity: 1;
}

.image-preview-remove:hover {
    background: #b91c1c;
    transform: scale(1.1);
}

.image-preview-badge {
    position: absolute;
    bottom: 4px;
    left: 4px;
    padding: 2px 8px;
    background: var(--admin-accent);
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    border-radius: var(--radius-full);
}
</style>

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    const MAX_IMAGES = 3;
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageInput');
    const previewGrid = document.getElementById('imagePreviewGrid');
    const hiddenInputs = document.getElementById('hiddenImageInputs');
    const uploadContent = uploadZone.querySelector('.upload-content');
    const uploadLoading = uploadZone.querySelector('.upload-loading');
    
    let uploadedImages = []; // Array of {url: string, publicId: string}
    
    // Click to open file dialog
    uploadZone.addEventListener('click', () => {
        if (uploadedImages.length < MAX_IMAGES) {
            imageInput.click();
        }
    });
    
    // Drag and drop events
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => ALLOWED_TYPES.includes(f.type));
        handleFiles(files);
    });
    
    // File input change
    imageInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        imageInput.value = ''; // Reset for next selection
    });
    
    async function handleFiles(files) {
        const remaining = MAX_IMAGES - uploadedImages.length;
        const toUpload = files.slice(0, remaining);
        
        for (const file of toUpload) {
            if (file.size > MAX_FILE_SIZE) {
                alert(`Ảnh "${file.name}" vượt quá 5MB`);
                continue;
            }
            await uploadFile(file);
        }
    }
    
    async function uploadFile(file) {
        uploadZone.classList.add('uploading');
        uploadContent.style.display = 'none';
        uploadLoading.style.display = 'flex';
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/v1/images/books', {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
            
            const data = await response.json();
            uploadedImages.push({ url: data.url, publicId: data.publicId });
            renderPreviews();
            updateHiddenInputs();
            
        } catch (error) {
            console.error('Upload error:', error);
            alert('Lỗi tải ảnh: ' + error.message);
        } finally {
            uploadZone.classList.remove('uploading');
            uploadContent.style.display = 'block';
            uploadLoading.style.display = 'none';
            updateUploadZoneVisibility();
        }
    }
    
    function renderPreviews() {
        previewGrid.innerHTML = '';
        uploadedImages.forEach((img, index) => {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            item.innerHTML = `
                <img src="${img.url}" alt="Preview ${index + 1}">
                <button type="button" class="image-preview-remove" onclick="removeImage(${index})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                    </svg>
                </button>
                ${index === 0 ? '<span class="image-preview-badge">Chính</span>' : ''}
            `;
            previewGrid.appendChild(item);
        });
    }
    
    function updateHiddenInputs() {
        hiddenInputs.innerHTML = '';
        uploadedImages.forEach((img, index) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `imageUrls[${index}]`;
            input.value = img.url;
            hiddenInputs.appendChild(input);
        });
    }
    
    function updateUploadZoneVisibility() {
        if (uploadedImages.length >= MAX_IMAGES) {
            uploadZone.style.display = 'none';
        } else {
            uploadZone.style.display = 'block';
        }
    }
    
    // Global function for remove button
    window.removeImage = function(index) {
        uploadedImages.splice(index, 1);
        renderPreviews();
        updateHiddenInputs();
        updateUploadZoneVisibility();
    };
});
</script>
</body>
</html>
